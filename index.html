<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCCU Rideshare Planning</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .header-bg { background: linear-gradient(135deg, #0d6efd, #0a58ca); color: white; padding: 2rem 0; margin-bottom: 2rem; }
        .time-input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 1.2rem; cursor: pointer;
        }
        .time-input:focus { background: white; color: #0d6efd; outline: none; }
        .time-input::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        .pac-container { z-index: 100000 !important; } 
        #map { height: 550px; width: 100%; border-radius: 12px; background-color: #e9ecef; }
        .inactive-row { opacity: 0.5; background-color: #f8f9fa; }
        .dep-time { font-size: 1.2rem; font-weight: bold; color: #d63384; }
        .search-container { position: relative; }
        .search-icon { position: absolute; left: 15px; top: 10px; color: #aaa; }
        .search-input { padding-left: 40px; border-radius: 20px; }
    </style>
</head>
<body>

<div class="header-bg text-center">
    <h1>KCCU Rideshare Planning</h1>
    <div class="d-flex justify-content-center align-items-center gap-3 mt-3">
        <span>Destination: <strong>608 W Green St</strong></span>
        <span>|</span>
        <div class="d-flex align-items-center gap-2">
            <span>Target Arrival:</span>
            <input type="time" id="target-time" class="time-input" value="06:28">
        </div>
    </div>
</div>

<div class="container">
    <div id="error-container" class="alert alert-danger d-none"></div>

    <div class="row">
        <div class="col-lg-5">
            <div class="mb-3">
                <div class="search-container mb-3">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="search-box" class="form-control search-input" placeholder="Find name or address..." onkeyup="filterLists()">
                </div>
                <div class="d-flex justify-content-between">
                    <button class="btn btn-sm btn-outline-primary" onclick="generateMagicLink()">üîó Create Magic Link</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearAllData()">üóëÔ∏è Reset</button>
                </div>
            </div>

            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0">üöó Drivers</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary py-0" onclick="setAll('driver', true)">All</button>
                        <button class="btn btn-sm btn-outline-secondary py-0 me-2" onclick="setAll('driver', false)">None</button>
                        <button class="btn btn-sm btn-primary" onclick="openModal('driver', -1)">+ New</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <tbody id="drivers-list-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0">üôã Passengers</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary py-0" onclick="setAll('passenger', true)">All</button>
                        <button class="btn btn-sm btn-outline-secondary py-0 me-2" onclick="setAll('passenger', false)">None</button>
                        <button class="btn btn-sm btn-primary" onclick="openModal('passenger', -1)">+ New</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <tbody id="passengers-list-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="d-grid gap-2">
                <div class="row g-2">
                    <div class="col-8">
                        <div class="input-group">
                            <span class="input-group-text">Mode</span>
                            <select id="optimize-mode" class="form-select fw-bold">
                                <option value="distance">üìè Min Distance (Seeded)</option>
                                <option value="time">‚è±Ô∏è Fastest Time (Google)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="input-group" title="Seconds allowed per stop">
                            <span class="input-group-text">‚è≥</span>
                            <input type="number" id="stop-duration" class="form-control text-center fw-bold" value="30" min="0">
                        </div>
                    </div>
                </div>

                <button class="btn btn-success py-3 fw-bold shadow-sm" onclick="calculateSmartRoutes()">
                    ‚ö° Generate Optimized Routes
                </button>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" onclick="generateShareText()">üìã Copy Text Plan</button>
                    <button class="btn btn-outline-secondary" onclick="showDebugModal()">‚ùì Check Distances</button>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card p-2">
                <div id="map"></div>
            </div>
            <div id="results-area" class="card p-4" style="display:none; background-color: #fff9fa; border: 1px solid #pink;">
                <h3 class="mb-4">üìÖ Today's Plan</h3>
                <div id="routes-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addPersonModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Manage Person</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="entry-type">
                <input type="hidden" id="entry-index" value="-1">
                <input type="hidden" id="entry-lat">
                <input type="hidden" id="entry-lng">

                <div class="mb-3">
                    <label>Name</label>
                    <input type="text" class="form-control" id="entry-name">
                </div>
                <div class="mb-3" id="cap-container">
                    <label>Car Capacity</label>
                    <input type="number" class="form-control" id="entry-cap" value="4">
                </div>
                <div class="mb-3">
                    <label>Address</label>
                    <input type="text" class="form-control" id="entry-address" placeholder="Start typing address..." autocomplete="off" oninput="wipeCoords()">
                    <small id="addr-warning" class="text-muted">Start typing and <strong>click</strong> the dropdown suggestion.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="savePerson()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="debugModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìç Distance Matrix Debugger</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Use this to verify if the computer knows two people are at the same location (Distance should be 0 or <10m).</p>
                <textarea id="debug-text-area" class="form-control" style="height: 400px; font-family: monospace;" readonly></textarea>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="shareModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìã Shareable Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea id="share-text-area" class="form-control" style="height: 200px;" readonly></textarea>
                <div class="alert alert-success mt-2 mb-0">Copied to clipboard!</div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const CHURCH_LOCATION = { lat: 40.1106, lng: -88.2166, address: "608 W Green St, Urbana, IL 61801" };
    let map, geocoder, directionsService;
    let routeRenderers = []; 
    let lastCalculatedDrivers = [];
    let myModal, debugModal, shareModal;

    // --- DATA SAFETY FIX: Load immediately ---
    let driversData = JSON.parse(localStorage.getItem('driversData')) || [];
    let passengersData = JSON.parse(localStorage.getItem('passengersData')) || [];

    document.addEventListener("DOMContentLoaded", function() {
        const m1 = document.getElementById('addPersonModal');
        const m2 = document.getElementById('debugModal');
        const m3 = document.getElementById('shareModal');
        if(m1) myModal = new bootstrap.Modal(m1);
        if(m2) debugModal = new bootstrap.Modal(m2);
        if(m3) shareModal = new bootstrap.Modal(m3);
        
        checkUrlForData();
        renderLists();
    });

    // --- UTILS ---
    function safeBtoa(str) { return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1))); }
    function safeAtob(str) { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); }
    function getDistance(p1, p2) {
        if(!p1.lat || !p2.lat) return 99999; 
        const R = 6371; 
        const dLat = (p2.lat - p1.lat) * Math.PI/180;
        const dLon = (p2.lng - p1.lng) * Math.PI/180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(p1.lat * Math.PI/180) * Math.cos(p2.lat * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function checkUrlForData() {
        const urlParams = new URLSearchParams(window.location.search);
        let rawData = urlParams.get('data');
        if(rawData) {
            try {
                if(rawData.includes(' ') && !rawData.includes('+')) rawData = rawData.replace(/ /g, '+');
                
                let jsonString;
                try {
                    const decompressed = LZString.decompressFromEncodedURIComponent(rawData);
                    if(decompressed) jsonString = decompressed;
                } catch(e) {}

                if(!jsonString) {
                    try { rawData = decodeURIComponent(rawData); } catch(e){}
                    jsonString = safeAtob(rawData);
                }

                if(jsonString) {
                    const decoded = JSON.parse(jsonString);
                    driversData = decoded.d || [];
                    passengersData = decoded.p || [];
                    localStorage.setItem('driversData', JSON.stringify(driversData));
                    localStorage.setItem('passengersData', JSON.stringify(passengersData));
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch(e) {
                console.error("Link Error:", e);
                const errBox = document.getElementById('error-container');
                errBox.innerText = "‚ö†Ô∏è Link Error: Using local backup.";
                errBox.classList.remove('d-none');
            }
        }
    }

    function initMap() {
        try {
            const champaign = { lat: 40.1106, lng: -88.225 };
            map = new google.maps.Map(document.getElementById("map"), { zoom: 14, center: champaign });
            directionsService = new google.maps.DirectionsService();
            enableAutocomplete('entry-address');
        } catch(e) { console.error("Map failed to load:", e); }
    }

    function enableAutocomplete(id) {
        const input = document.getElementById(id);
        if(!input || !window.google) return;
        const autocomplete = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: "us" }, fields: ["formatted_address", "geometry", "name"] });
        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();
            if(place.formatted_address) {
                input.value = place.formatted_address;
                if(place.geometry && place.geometry.location) {
                    document.getElementById('entry-lat').value = place.geometry.location.lat();
                    document.getElementById('entry-lng').value = place.geometry.location.lng();
                    document.getElementById('addr-warning').innerHTML = '<span class="text-success">‚úÖ GPS Coordinates Locked!</span>';
                }
            }
        });
    }
    
    function wipeCoords() {
        document.getElementById('entry-lat').value = '';
        document.getElementById('entry-lng').value = '';
        document.getElementById('addr-warning').innerHTML = '<span class="text-danger">‚ö†Ô∏è Unsaved changes. Please select from dropdown.</span>';
    }

    function renderLists() {
        const dList = document.getElementById('drivers-list-body');
        const pList = document.getElementById('passengers-list-body');
        if(!dList || !pList) return; 
        dList.innerHTML = ''; pList.innerHTML = '';
        driversData.forEach((d, idx) => dList.innerHTML += createRow(d, idx, 'driver'));
        passengersData.forEach((p, idx) => pList.innerHTML += createRow(p, idx, 'passenger'));
        
        localStorage.setItem('driversData', JSON.stringify(driversData));
        localStorage.setItem('passengersData', JSON.stringify(passengersData));
        filterLists();
    }
    
    function filterLists() {
        const term = document.getElementById('search-box').value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = (term === "" || text.includes(term)) ? "" : "none";
        });
    }

    function createRow(item, idx, type) {
        const isChecked = item.active ? 'checked' : '';
        const rowClass = item.active ? '' : 'inactive-row';
        const info = type === 'driver' ? `<small>Cap: ${item.capacity}</small>` : '';
        const geoStatus = (item.lat && item.lng && !isNaN(item.lat)) ? '<span class="text-success" title="GPS Locked">üìç</span>' : '<span class="text-danger" title="NO GPS DATA!">‚ö†Ô∏è</span>';
        return `
            <tr class="${rowClass}">
                <td style="width:10%"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" ${isChecked} onchange="toggleActive('${type}', ${idx})"></div></td>
                <td><strong>${item.name}</strong> ${info} ${geoStatus}<br><small class="text-muted text-truncate" style="max-width: 150px; display:block;">${item.address}</small></td>
                <td class="text-end" style="width:25%">
                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="openModal('${type}', ${idx})">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${type}', ${idx})">√ó</button>
                </td>
            </tr>`;
    }

    function toggleActive(type, idx) {
        if(type === 'driver') driversData[idx].active = !driversData[idx].active;
        else passengersData[idx].active = !passengersData[idx].active;
        renderLists();
    }
    
    function setAll(type, activeStatus) {
        if(type === 'driver') driversData.forEach(d => d.active = activeStatus);
        else passengersData.forEach(p => p.active = activeStatus);
        renderLists();
    }

    function deleteItem(type, idx) {
        if(confirm('Delete this person?')) {
            if(type === 'driver') driversData.splice(idx, 1);
            else passengersData.splice(idx, 1);
            renderLists();
        }
    }
    
    function clearAllData() {
        if(confirm("Are you sure you want to delete ALL data?")) {
            driversData = []; passengersData = [];
            renderLists();
        }
    }

    function openModal(type, index) {
        document.getElementById('entry-type').value = type;
        document.getElementById('entry-index').value = index;
        document.getElementById('cap-container').style.display = type === 'driver' ? 'block' : 'none';
        document.getElementById('entry-lat').value = '';
        document.getElementById('entry-lng').value = '';
        document.getElementById('addr-warning').innerHTML = 'Start typing and <strong>click</strong> the dropdown suggestion.';
        document.getElementById('modalTitle').innerText = (index === -1) ? "New " + (type==='driver'?'Driver':'Passenger') : "Edit " + (type==='driver'?'Driver':'Passenger');
        
        if (index > -1) {
            const data = type === 'driver' ? driversData[index] : passengersData[index];
            document.getElementById('entry-name').value = data.name;
            document.getElementById('entry-address').value = data.address;
            if(data.lat) {
                document.getElementById('entry-lat').value = data.lat;
                document.getElementById('entry-lng').value = data.lng;
                document.getElementById('addr-warning').innerHTML = '<span class="text-success">‚úÖ GPS Coordinates Locked!</span>';
            }
            if (type === 'driver') document.getElementById('entry-cap').value = data.capacity;
        } else {
            document.getElementById('entry-name').value = '';
            document.getElementById('entry-address').value = '';
            document.getElementById('entry-cap').value = '4';
        }
        myModal.show();
    }

    function savePerson() {
        const type = document.getElementById('entry-type').value;
        const index = parseInt(document.getElementById('entry-index').value);
        const name = document.getElementById('entry-name').value;
        const addr = document.getElementById('entry-address').value;
        const lat = parseFloat(document.getElementById('entry-lat').value);
        const lng = parseFloat(document.getElementById('entry-lng').value);

        if(!name || !addr) return alert("Please fill in fields");
        if(isNaN(lat) || isNaN(lng)) return alert("STOP: GPS Missing. Please select address from dropdown.");

        const person = { name, address: addr, lat, lng, active: true };
        if(type === 'driver') {
            person.capacity = parseInt(document.getElementById('entry-cap').value);
            if (index === -1) driversData.push(person); else { person.active = driversData[index].active; driversData[index] = person; }
        } else {
            if (index === -1) passengersData.push(person); else { person.active = passengersData[index].active; passengersData[index] = person; }
        }
        renderLists();
        myModal.hide();
    }

    function generateMagicLink() {
        try {
            const payload = { d: driversData, p: passengersData };
            const jsonString = JSON.stringify(payload);
            const compressed = LZString.compressToEncodedURIComponent(jsonString);
            const baseURL = window.location.origin + window.location.pathname;
            const magicLink = `${baseURL}?data=${compressed}`;
            document.getElementById('share-text-area').value = magicLink;
            shareModal.show();
            setTimeout(() => {
                const ta = document.getElementById('share-text-area');
                ta.select(); ta.setSelectionRange(0, 99999);
                navigator.clipboard.writeText(magicLink).then(() => {
                    document.querySelector('#shareModal .alert').innerText = "‚úÖ Link copied!";
                    document.querySelector('#shareModal .alert').className = "alert alert-success mt-2 mb-0";
                });
            }, 500);
        } catch (e) { alert("Error: " + e.message); }
    }

    function generateShareText() {
        if(!lastCalculatedDrivers.length) return alert("Please generate a schedule first!");
        let shareText = "üìÖ *Ride Plan*\n\n";
        lastCalculatedDrivers.forEach(d => {
            if(d.route.length > 0) {
                let names = [];
                d.route.forEach(stop => stop.passengers.forEach(p => names.push(p.name)));
                shareText += `üöó *${d.name}*: ${names.join(", ")}\n`;
            }
        });
        document.getElementById('share-text-area').value = shareText;
        shareModal.show();
        setTimeout(() => {
            const ta = document.getElementById('share-text-area');
            ta.select(); ta.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(shareText);
        }, 500);
    }
    
    function showDebugModal() {
        let pool = passengersData.filter(p => p.active);
        let txt = pool.length < 2 ? "Need 2+ active passengers." : "";
        for(let i=0; i<pool.length; i++) {
            for(let j=i+1; j<pool.length; j++) {
                let d = getDistance(pool[i], pool[j]);
                txt += `${pool[i].name} ‚Üî ${pool[j].name} = ${Math.round(d * 1000)}m\n`;
            }
        }
        document.getElementById('debug-text-area').value = txt;
        debugModal.show();
    }

    // --- ALGORITHM: SEED & GROW (Strict Phases) ---
    function calculateSmartRoutes() {
        const timeInput = document.getElementById('target-time').value;
        const mode = document.getElementById('optimize-mode').value; 
        const stopDuration = parseInt(document.getElementById('stop-duration').value) || 30;
        
        if(!timeInput) return alert("Set arrival time.");
        if(window.google) { routeRenderers.forEach(r => r.setMap(null)); routeRenderers = []; }

        let drivers = driversData.filter(d => d.active).map(d => ({ ...d, route: [], currentLoad: 0, currentLat: d.lat, currentLng: d.lng }));
        let rawPassengers = passengersData.filter(p => p.active).map(p => ({...p}));

        if(drivers.length === 0 || rawPassengers.length === 0) return alert("Need active drivers and passengers.");
        if(drivers.some(d => isNaN(d.lat)) || rawPassengers.some(p => isNaN(p.lat))) return alert("CRITICAL: Fix GPS errors.");

        // 1. PRE-PROCESS: GROUPING (10m)
        let stops = [];
        while(rawPassengers.length > 0) {
            let p = rawPassengers.pop();
            let stop = { lat: p.lat, lng: p.lng, address: p.address, passengers: [p], assigned: false };
            for(let i = rawPassengers.length - 1; i >= 0; i--) {
                if(getDistance(p, rawPassengers[i]) < 0.01) {
                    stop.passengers.push(rawPassengers[i]);
                    rawPassengers.splice(i, 1);
                }
            }
            stops.push(stop);
        }

        // 2. PHASE 1: SEEDING
        // For every empty driver, find their SINGLE nearest stop.
        // Sort all potential (Driver, Stop) pairs by distance to ensure global optimality.
        let seedPairs = [];
        drivers.forEach((d, dIdx) => {
            stops.forEach((s, sIdx) => {
                if (d.capacity >= s.passengers.length) { // Strict Capacity Check
                    seedPairs.push({
                        dist: getDistance({lat: d.lat, lng: d.lng}, s),
                        dIdx: dIdx,
                        sIdx: sIdx
                    });
                }
            });
        });
        seedPairs.sort((a, b) => a.dist - b.dist);

        // Assign Seeds (1 per driver max)
        seedPairs.forEach(pair => {
            let d = drivers[pair.dIdx];
            let stop = stops[pair.sIdx];
            if (d.route.length === 0 && !stop.assigned) {
                stop.assigned = true;
                d.route.push(stop);
                d.currentLoad += stop.passengers.length;
                d.currentLat = stop.lat;
                d.currentLng = stop.lng;
            }
        });

        // 3. PHASE 2: EXPANSION (CHAINING)
        // Drivers now look for the next nearest stop from their CURRENT location
        let active = true;
        while(active) {
            active = false;
            let bestMove = null;
            let minDist = Infinity;

            // Iterate over all drivers who have space
            drivers.forEach(d => {
                let seatsLeft = d.capacity - d.currentLoad;
                if (seatsLeft > 0) {
                    stops.forEach((stop, sIdx) => {
                        if (!stop.assigned && seatsLeft >= stop.passengers.length) {
                            // Distance from driver's LAST STOP (currentLat)
                            let dist = getDistance({lat: d.currentLat, lng: d.currentLng}, stop);
                            if (dist < minDist) {
                                minDist = dist;
                                bestMove = { driver: d, stop: stop };
                            }
                        }
                    });
                }
            });

            if (bestMove) {
                bestMove.stop.assigned = true;
                bestMove.driver.route.push(bestMove.stop);
                bestMove.driver.currentLoad += bestMove.stop.passengers.length;
                bestMove.driver.currentLat = bestMove.stop.lat;
                bestMove.driver.currentLng = bestMove.stop.lng;
                active = true; // Continue until no one can move
            }
        }

        // 4. Collect Unassigned
        let leftoverStops = stops.filter(s => !s.assigned);

        // 5. Post-Process (Distance Mode Only)
        if(mode === 'distance') {
            drivers.forEach(d => {
                if(d.route.length > 1) {
                    let sorted = [];
                    let curr = { lat: d.lat, lng: d.lng }; // Start from Home
                    let rem = [...d.route];
                    while(rem.length > 0) {
                        let closestIdx = 0;
                        let minD = Infinity;
                        for(let i=0; i<rem.length; i++) {
                            let dist = getDistance(curr, rem[i]);
                            if(dist < minD) { minD = dist; closestIdx = i; }
                        }
                        let next = rem.splice(closestIdx, 1)[0];
                        sorted.push(next);
                        curr = { lat: next.lat, lng: next.lng };
                    }
                    d.route = sorted;
                }
            });
        }

        lastCalculatedDrivers = drivers;
        displayResults(drivers, leftoverStops, timeInput, mode, stopDuration);
    }

    function displayResults(drivers, leftoverStops, timeInput, mode, stopDuration) {
        const [tHour, tMin] = timeInput.split(':').map(Number);
        const list = document.getElementById('routes-list');
        document.getElementById('results-area').style.display = 'block';
        list.innerHTML = '';
        const bounds = window.google ? new google.maps.LatLngBounds() : null;
        const colors = ["#0000FF", "#FF0000", "#008000", "#FFA500", "#800080", "#008080"];
        const optimizeGoogle = (mode === 'time'); 

        drivers.forEach((d, dIdx) => {
            if(d.route.length === 0) return;
            const waypoints = d.route.map(stop => ({ location: stop.address, stopover: true }));
            
            if(window.google) {
                directionsService.route({
                    origin: d.address, destination: CHURCH_LOCATION.address, waypoints: waypoints,
                    optimizeWaypoints: optimizeGoogle, travelMode: google.maps.TravelMode.DRIVING
                }, (response, status) => {
                    if (status === "OK") {
                        const color = colors[dIdx % colors.length];
                        const renderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: false, preserveViewport: true, polylineOptions: { strokeColor: color, strokeWeight: 5 } });
                        routeRenderers.push(renderer);
                        renderer.setDirections(response);
                        response.routes[0].bounds && bounds.union(response.routes[0].bounds);
                        map.fitBounds(bounds);
                        renderDriverCard(d, color, response.routes[0].legs, waypoints, tHour, tMin, false, response.routes[0].waypoint_order, stopDuration);
                    } else { renderDriverCard(d, "#333", [], waypoints, tHour, tMin, true, [], stopDuration); }
                });
            } else { renderDriverCard(d, "#333", [], waypoints, tHour, tMin, true, [], stopDuration); }
        });
        
        let leftoverCount = 0;
        leftoverStops.forEach(s => leftoverCount += s.passengers.length);
        if(leftoverCount > 0) list.innerHTML += `<div class="alert alert-warning">‚ö†Ô∏è ${leftoverCount} passengers could not fit!</div>`;
    }

    function renderDriverCard(d, color, legs, waypoints, tHour, tMin, isError=false, order=[], stopDuration=30) {
        let depTimeStr = "--:--";
        if(!isError) {
            let totalSec = 0;
            legs.forEach(leg => totalSec += leg.duration.value);
            totalSec += (waypoints.length * stopDuration); 
            const target = new Date(); target.setHours(tHour, tMin, 0, 0);
            const depDate = new Date(target.getTime() - (totalSec * 1000));
            depTimeStr = depDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }
        let html = `<div class="card p-3 border-start border-5" style="border-color: ${color} !important;">
            <div class="d-flex justify-content-between"><h5><span style="color:${color}">üöò</span> ${d.name} <span class="badge bg-secondary">${d.currentLoad}/${d.capacity}</span></h5>
            <div class="text-end"><span class="text-muted">Depart:</span><br><span class="dep-time">${depTimeStr}</span></div></div><hr><ul class="list-unstyled">`;
        
        if(!order || order.length === 0) order = d.route.map((_, i) => i);
        order.forEach((idx, i) => {
            let stop = d.route[idx];
            let names = stop.passengers.map(p => p.name).join(" & ");
            html += `<li>${i+1}. Pick up <strong>${names}</strong> <br><small class="text-muted">${stop.address}</small></li>`;
        });
        html += `</ul></div>`;
        document.getElementById('routes-list').innerHTML += html;
    }
</script>
    
<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCH4mU6UnzIey7YtHyOg9TPaxX4K1SzpzA&callback=initMap&libraries=places&v=weekly"
    defer
></script>

</body>
</html>
